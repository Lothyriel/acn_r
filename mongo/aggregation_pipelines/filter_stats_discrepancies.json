[
  {
    "$group": {
      "_id": "$user_id",
      "ConnectedCount": {
        "$sum": {
          "$cond": [
            {
              "$eq": [
                "$activity_type",
                "Connected"
              ]
            },
            1,
            0
          ]
        }
      },
      "DisconnectedCount": {
        "$sum": {
          "$cond": [
            {
              "$eq": [
                "$activity_type",
                "Disconnected"
              ]
            },
            1,
            0
          ]
        }
      },
      "guild_ids": {
        "$addToSet": "$guild_id"
      }
    }
  },
  {
    "$match": {
      "$expr": {
        "$ne": [
          "$ConnectedCount",
          "$DisconnectedCount"
        ]
      }
    }
  },
  {
    "$project": {
      "user_id": "$_id",
      "_id": 0,
      "ConnectedCount": 1,
      "DisconnectedCount": 1,
      "guild_ids": 1
    }
  },
  {
    "$sort": {
      "ConnectedCount": 1
    }
  }
]
